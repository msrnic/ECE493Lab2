openapi: 3.0.3
info:
  title: Reviewer Assignment API
  version: 1.0.0
  description: >-
    REST contract for UC-06 (Assign Reviewers) and UC-07 (Receive Review Invitation).
servers:
  - url: https://cms.example.com/api
    description: Production
  - url: http://localhost:3000/api
    description: Local

tags:
  - name: Editor Assignment
  - name: Invitation Delivery

paths:
  /papers:
    get:
      tags: [Editor Assignment]
      summary: List papers eligible for reviewer assignment
      parameters:
        - in: query
          name: state
          required: true
          schema:
            type: string
            enum: [submitted]
      responses:
        '200':
          description: Eligible papers
          content:
            application/json:
              schema:
                type: object
                required: [papers]
                properties:
                  papers:
                    type: array
                    items:
                      $ref: '#/components/schemas/PaperSummary'

  /papers/{paperId}/reviewer-candidates:
    get:
      tags: [Editor Assignment]
      summary: Get reviewer candidates with availability and COI eligibility
      parameters:
        - $ref: '#/components/parameters/PaperId'
      responses:
        '200':
          description: Candidate list
          content:
            application/json:
              schema:
                type: object
                required: [paperId, candidates]
                properties:
                  paperId:
                    type: string
                    format: uuid
                  candidates:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReviewerCandidate'
        '404':
          $ref: '#/components/responses/NotFound'

  /papers/{paperId}/assignment-attempts:
    post:
      tags: [Editor Assignment]
      summary: Start or replace an assignment attempt draft
      parameters:
        - $ref: '#/components/parameters/PaperId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignmentAttemptCreateRequest'
      responses:
        '201':
          description: Assignment attempt created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignmentAttempt'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Paper is no longer assignable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /papers/{paperId}/assignment-attempts/{attemptId}/selections/{selectionId}:
    patch:
      tags: [Editor Assignment]
      summary: Replace an unavailable or conflicted reviewer in a slot
      parameters:
        - $ref: '#/components/parameters/PaperId'
        - $ref: '#/components/parameters/AttemptId'
        - $ref: '#/components/parameters/SelectionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReplaceSelectionRequest'
      responses:
        '200':
          description: Selection updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignmentSelection'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /papers/{paperId}/assignment-attempts/{attemptId}/confirm:
    post:
      tags: [Editor Assignment]
      summary: Confirm assignment attempt (first confirmation wins)
      parameters:
        - $ref: '#/components/parameters/PaperId'
        - $ref: '#/components/parameters/AttemptId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmAssignmentRequest'
      responses:
        '200':
          description: Assignment confirmed and invitation processing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignmentOutcome'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Stale confirmation; another editor already confirmed first
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StaleConfirmError'

  /papers/{paperId}/assignment-outcomes/{attemptId}:
    get:
      tags: [Editor Assignment]
      summary: Retrieve assignment result and invitation status visibility
      parameters:
        - $ref: '#/components/parameters/PaperId'
        - $ref: '#/components/parameters/AttemptId'
      responses:
        '200':
          description: Assignment outcome
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignmentOutcome'
        '404':
          $ref: '#/components/responses/NotFound'

  /invitations/{invitationId}/dispatch:
    post:
      tags: [Invitation Delivery]
      summary: Dispatch invitation for a newly created reviewer assignment
      parameters:
        - $ref: '#/components/parameters/InvitationId'
      responses:
        '202':
          description: Dispatch accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvitationStatus'
        '404':
          $ref: '#/components/responses/NotFound'

  /invitations/{invitationId}/retry:
    post:
      tags: [Invitation Delivery]
      summary: Perform one retry attempt after delivery failure
      parameters:
        - $ref: '#/components/parameters/InvitationId'
      responses:
        '200':
          description: Retry processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvitationStatus'
        '404':
          $ref: '#/components/responses/NotFound'

  /invitations/{invitationId}:
    get:
      tags: [Invitation Delivery]
      summary: Get current invitation delivery state
      parameters:
        - $ref: '#/components/parameters/InvitationId'
      responses:
        '200':
          description: Current invitation state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvitationStatus'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    PaperId:
      in: path
      name: paperId
      required: true
      schema:
        type: string
        format: uuid
    AttemptId:
      in: path
      name: attemptId
      required: true
      schema:
        type: string
        format: uuid
    SelectionId:
      in: path
      name: selectionId
      required: true
      schema:
        type: string
        format: uuid
    InvitationId:
      in: path
      name: invitationId
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    PaperSummary:
      type: object
      required: [paperId, title, state, assignmentVersion]
      properties:
        paperId:
          type: string
          format: uuid
        title:
          type: string
        state:
          type: string
          enum: [submitted]
        assignmentVersion:
          type: integer
          minimum: 0

    ReviewerCandidate:
      type: object
      required: [reviewerId, displayName, availabilityStatus, coiFlag]
      properties:
        reviewerId:
          type: string
          format: uuid
        displayName:
          type: string
        availabilityStatus:
          type: string
          enum: [available, unavailable]
        coiFlag:
          type: boolean

    AssignmentSelectionInput:
      type: object
      required: [slotNumber, reviewerId]
      properties:
        slotNumber:
          type: integer
          minimum: 1
        reviewerId:
          type: string
          format: uuid

    AssignmentAttemptCreateRequest:
      type: object
      required: [editorId, basePaperVersion, selections]
      properties:
        editorId:
          type: string
        basePaperVersion:
          type: integer
          minimum: 0
        selections:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/AssignmentSelectionInput'

    AssignmentSelection:
      type: object
      required:
        - selectionId
        - slotNumber
        - reviewerId
        - availabilitySnapshot
        - coiSnapshot
        - status
      properties:
        selectionId:
          type: string
          format: uuid
        slotNumber:
          type: integer
          minimum: 1
        reviewerId:
          type: string
          format: uuid
        availabilitySnapshot:
          type: string
          enum: [available, unavailable]
        coiSnapshot:
          type: boolean
        status:
          type: string
          enum: [selected, needs_replacement, replaced, eligible]
        replacedBySelectionId:
          type: string
          format: uuid
          nullable: true

    AssignmentAttempt:
      type: object
      required: [attemptId, paperId, status, basePaperVersion, selections]
      properties:
        attemptId:
          type: string
          format: uuid
        paperId:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - draft
            - blocked_unavailable
            - blocked_coi
            - ready_to_confirm
            - confirmed
            - rejected_stale
            - cancelled
        basePaperVersion:
          type: integer
          minimum: 0
        selections:
          type: array
          items:
            $ref: '#/components/schemas/AssignmentSelection'

    ReplaceSelectionRequest:
      type: object
      required: [replacementReviewerId]
      properties:
        replacementReviewerId:
          type: string
          format: uuid

    ConfirmAssignmentRequest:
      type: object
      required: [editorId, basePaperVersion]
      properties:
        editorId:
          type: string
        basePaperVersion:
          type: integer
          minimum: 0

    AssignedReviewer:
      type: object
      required: [assignmentId, reviewerId, displayName, invitation]
      properties:
        assignmentId:
          type: string
          format: uuid
        reviewerId:
          type: string
          format: uuid
        displayName:
          type: string
        replacedReviewerId:
          type: string
          format: uuid
          nullable: true
        invitation:
          $ref: '#/components/schemas/InvitationStatus'

    InvitationStatus:
      type: object
      required: [invitationId, status, retryCount, followUpRequired]
      properties:
        invitationId:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, sent, retry_scheduled, failed_terminal]
        retryCount:
          type: integer
          minimum: 0
          maximum: 3
        nextRetryAt:
          type: string
          format: date-time
          nullable: true
        followUpRequired:
          type: boolean
        lastError:
          type: string
          nullable: true

    AssignmentOutcome:
      type: object
      required:
        - paperId
        - attemptId
        - outcome
        - assignedReviewers
        - followUpRequired
      properties:
        paperId:
          type: string
          format: uuid
        attemptId:
          type: string
          format: uuid
        outcome:
          type: string
          enum: [confirmed, rejected_stale]
        assignedReviewers:
          type: array
          items:
            $ref: '#/components/schemas/AssignedReviewer'
        replacedReviewers:
          type: array
          items:
            type: object
            required: [slotNumber, originalReviewerId, replacementReviewerId]
            properties:
              slotNumber:
                type: integer
              originalReviewerId:
                type: string
                format: uuid
              replacementReviewerId:
                type: string
                format: uuid
        followUpRequired:
          type: boolean
        message:
          type: string

    StaleConfirmError:
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
        - type: object
          required: [code, message, currentAssignmentVersion]
          properties:
            code:
              type: string
              enum: [STALE_CONFIRMATION]
            currentAssignmentVersion:
              type: integer
              minimum: 0

    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
