openapi: 3.1.0
info:
  title: CMS Registration Clarification API
  version: 1.0.0
  description: >-
    Contract for UC-01 registration, confirmation, throttling feedback, and
    confirmation-recovery behavior.
servers:
  - url: https://cms.example.com
paths:
  /register:
    get:
      summary: Show registration page for unauthenticated users
      operationId: showRegistrationPage
      tags:
        - RegistrationView
      responses:
        "200":
          description: Registration form HTML for public users.
          content:
            text/html:
              schema:
                type: string
        "302":
          description: Already-authenticated user is redirected away from registration.
          headers:
            Location:
              description: Destination URL (for example, dashboard).
              schema:
                type: string

  /api/v1/registrations:
    post:
      summary: Submit registration details
      operationId: createRegistration
      tags:
        - Registrations
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          description: Key used to guarantee safe re-submission outcomes.
          schema:
            type: string
            minLength: 16
            maxLength: 128
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegistrationCreateRequest"
      responses:
        "201":
          description: Registration accepted; account created in pending state.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegistrationCreateResponse"
        "200":
          description: Safe re-submission replayed the original final outcome.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegistrationCreateResponse"
        "403":
          description: Registration denied for already-authenticated user.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                authenticatedUser:
                  value:
                    code: REGISTRATION_NOT_ALLOWED_WHILE_AUTHENTICATED
                    message: Registration is only available to signed-out users.
                    guidance:
                      - Continue to dashboard
                      - Sign out before creating another account
        "409":
          description: Email already reserved by an existing pending or active account.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                duplicateEmail:
                  value:
                    code: EMAIL_ALREADY_REGISTERED
                    message: Email already registered.
                    guidance:
                      - Go to login
                      - Use reset password
        "422":
          description: Validation failed with field-level missing/invalid detail.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "429":
          description: Attempt limit exceeded and temporary block is active.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ThrottledErrorResponse"

  /api/v1/registrations/confirm:
    post:
      summary: Confirm pending account with one-time token
      operationId: confirmRegistration
      tags:
        - Registrations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmationRequest"
      responses:
        "200":
          description: Pending account activated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfirmationResponse"
        "400":
          description: Token is malformed or unknown.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidToken:
                  value:
                    code: CONFIRMATION_TOKEN_INVALID
                    message: The confirmation link is invalid.
                    guidance:
                      - Request a new confirmation email
        "410":
          description: Token expired and cannot be used.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                expiredToken:
                  value:
                    code: CONFIRMATION_TOKEN_EXPIRED
                    message: The confirmation link has expired.
                    guidance:
                      - Request a new confirmation email
        "409":
          description: Token already consumed or account already activated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                reusedToken:
                  value:
                    code: CONFIRMATION_TOKEN_REUSED
                    message: This confirmation link has already been used.
                    guidance:
                      - Log in
                      - Request a new confirmation email if account is still pending

  /api/v1/registrations/resend-confirmation:
    post:
      summary: Request a new confirmation email and replacement token
      operationId: resendConfirmation
      tags:
        - Registrations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResendConfirmationRequest"
      responses:
        "202":
          description: Replacement token issued and email delivery queued.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResendConfirmationResponse"
        "404":
          description: No pending registration found for provided email.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                noPendingAccount:
                  value:
                    code: NO_PENDING_REGISTRATION
                    message: No pending registration was found for this email.
                    guidance:
                      - Register a new account
                      - Log in if already active
        "409":
          description: Account is already active; resend not required.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                activeAccount:
                  value:
                    code: ACCOUNT_ALREADY_ACTIVE
                    message: This account is already active.
                    guidance:
                      - Log in

components:
  schemas:
    RegistrationCreateRequest:
      type: object
      required:
        - fullName
        - email
        - password
      properties:
        fullName:
          type: string
          minLength: 1
          maxLength: 120
        email:
          type: string
          format: email
          maxLength: 254
        password:
          type: string
          minLength: 12
          description: Must include uppercase, lowercase, number, and symbol.
      additionalProperties: false

    RegistrationCreateResponse:
      type: object
      required:
        - submissionId
        - accountStatus
        - emailDeliveryStatus
        - message
        - confirmationRequired
        - idempotencyReplayed
      properties:
        submissionId:
          type: string
        accountStatus:
          type: string
          enum:
            - pending
        emailDeliveryStatus:
          type: string
          enum:
            - sent
            - retry_pending
        confirmationRequired:
          type: boolean
          const: true
        confirmationLinkExpiresAt:
          type: string
          format: date-time
        idempotencyReplayed:
          type: boolean
        message:
          type: string

    ConfirmationRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          minLength: 16
          maxLength: 512
      additionalProperties: false

    ConfirmationResponse:
      type: object
      required:
        - accountId
        - accountStatus
        - message
      properties:
        accountId:
          type: string
        accountStatus:
          type: string
          enum:
            - active
        message:
          type: string

    ResendConfirmationRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
      additionalProperties: false

    ResendConfirmationResponse:
      type: object
      required:
        - accountStatus
        - emailDeliveryStatus
        - message
      properties:
        accountStatus:
          type: string
          enum:
            - pending
        emailDeliveryStatus:
          type: string
          enum:
            - queued
            - retry_pending
        message:
          type: string

    ValidationErrorItem:
      type: object
      required:
        - field
        - errorType
        - code
        - message
      properties:
        field:
          type: string
        errorType:
          type: string
          enum:
            - missing
            - invalid
        code:
          type: string
        message:
          type: string

    ValidationErrorResponse:
      type: object
      required:
        - code
        - message
        - errors
      properties:
        code:
          type: string
          enum:
            - VALIDATION_FAILED
        message:
          type: string
        errors:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ValidationErrorItem"

    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        guidance:
          type: array
          items:
            type: string

    ThrottledErrorResponse:
      allOf:
        - $ref: "#/components/schemas/ErrorResponse"
        - type: object
          required:
            - retryAfterSeconds
            - unblockAt
          properties:
            retryAfterSeconds:
              type: integer
              minimum: 1
            unblockAt:
              type: string
              format: date-time
