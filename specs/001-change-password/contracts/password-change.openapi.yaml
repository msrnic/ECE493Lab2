openapi: 3.1.0
info:
  title: CMS Account Security API
  version: 0.1.0
  description: Contract for UC-03 change-password behavior.
servers:
  - url: https://cms.example.edu
tags:
  - name: AccountSecurity
    description: Endpoints for authenticated account credential security actions.
paths:
  /api/v1/account/password-change:
    post:
      tags:
        - AccountSecurity
      summary: Change the authenticated user's password
      description: Verifies current password, validates new password policy, and updates credentials.
      operationId: changePassword
      x-traceability:
        useCases:
          - UC-03
        acceptanceSuites:
          - UC-03-AS
        requirements:
          - FR-001
          - FR-002
          - FR-003
          - FR-004
          - FR-005
          - FR-006
          - FR-007
          - FR-008
          - FR-010
          - FR-011
          - FR-012
          - FR-013
      security:
        - sessionCookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PasswordChangeRequest"
      responses:
        "200":
          description: Password updated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PasswordChangeSuccessResponse"
        "400":
          description: Invalid payload (missing or malformed fields).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: User is not authenticated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Request is syntactically valid but business validation failed.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PasswordChangeRejectedResponse"
        "429":
          description: Too many incorrect current-password attempts; request temporarily blocked.
          headers:
            Retry-After:
              description: Seconds remaining before next allowed attempt.
              schema:
                type: integer
                minimum: 1
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PasswordChangeRejectedResponse"
        "500":
          description: Internal service error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  securitySchemes:
    sessionCookieAuth:
      type: apiKey
      in: cookie
      name: cms_session
  schemas:
    PasswordChangeRequest:
      type: object
      additionalProperties: false
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
          minLength: 1
          description: User's current password.
          writeOnly: true
        newPassword:
          type: string
          minLength: 1
          description: User's desired replacement password.
          writeOnly: true
    PasswordChangeSuccessResponse:
      type: object
      additionalProperties: false
      required:
        - status
        - message
        - changedAt
        - sessionsInvalidated
        - currentSessionRetained
        - notificationQueued
        - auditId
      properties:
        status:
          type: string
          enum:
            - updated
        message:
          type: string
        changedAt:
          type: string
          format: date-time
        sessionsInvalidated:
          type: integer
          minimum: 0
        currentSessionRetained:
          type: boolean
        notificationQueued:
          type: boolean
        auditId:
          type: string
    PasswordChangeRejectedResponse:
      type: object
      additionalProperties: false
      required:
        - status
        - code
        - message
        - auditId
      properties:
        status:
          type: string
          enum:
            - rejected
        code:
          type: string
          enum:
            - INCORRECT_CURRENT_PASSWORD
            - PASSWORD_POLICY_VIOLATION
            - NEW_PASSWORD_SAME_AS_CURRENT
            - TEMPORARILY_BLOCKED
        message:
          type: string
        retryAfterSeconds:
          type: integer
          minimum: 1
        blockExpiresAt:
          type: string
          format: date-time
        auditId:
          type: string
    ErrorResponse:
      type: object
      additionalProperties: false
      required:
        - code
        - message
      properties:
        code:
          type: string
          enum:
            - INVALID_REQUEST
            - NOT_AUTHENTICATED
            - INTERNAL_ERROR
        message:
          type: string
