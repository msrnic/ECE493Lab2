openapi: 3.1.0
info:
  title: CMS Public Registration API
  version: 1.0.0
  description: API contract for UC-01 public user registration and confirmation.
servers:
  - url: https://cms.example.com
paths:
  /register:
    get:
      summary: Render registration page
      operationId: showRegistrationPage
      tags:
        - RegistrationView
      responses:
        "200":
          description: Registration form HTML
          content:
            text/html:
              schema:
                type: string
  /api/v1/registrations:
    post:
      summary: Submit registration details
      operationId: createRegistration
      tags:
        - Registrations
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          description: Client-generated unique key for safe retries.
          schema:
            type: string
            minLength: 16
            maxLength: 128
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegistrationCreateRequest"
      responses:
        "201":
          description: Account created in pending state; email sent or queued.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegistrationCreateResponse"
        "409":
          description: Email already registered.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                duplicateEmail:
                  value:
                    code: EMAIL_ALREADY_REGISTERED
                    message: Email already registered
                    guidance:
                      - /login
                      - /reset-password
        "422":
          description: Validation failure (missing/invalid fields including password policy).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "429":
          description: Registration attempts exceeded (5 attempts per rolling 10 minutes per email).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                throttled:
                  value:
                    code: REGISTRATION_THROTTLED
                    message: Too many registration attempts. Try again later.
                    retryAfterSeconds: 600
  /api/v1/registrations/confirm:
    post:
      summary: Confirm email and activate pending account
      operationId: confirmRegistration
      tags:
        - Registrations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmationRequest"
      responses:
        "200":
          description: Account activated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfirmationResponse"
        "400":
          description: Invalid or expired confirmation token.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Token is already consumed or account is already active.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  schemas:
    RegistrationCreateRequest:
      type: object
      required:
        - fullName
        - email
        - password
      properties:
        fullName:
          type: string
          minLength: 1
          maxLength: 120
        email:
          type: string
          format: email
          maxLength: 254
        password:
          type: string
          minLength: 12
          description: Must contain uppercase, lowercase, number, and symbol.
      additionalProperties: false
    RegistrationCreateResponse:
      type: object
      required:
        - accountId
        - accountStatus
        - emailDeliveryStatus
        - message
      properties:
        accountId:
          type: string
        accountStatus:
          type: string
          enum:
            - pending
        emailDeliveryStatus:
          type: string
          enum:
            - sent
            - pending_retry
        message:
          type: string
    ConfirmationRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          minLength: 16
          maxLength: 512
      additionalProperties: false
    ConfirmationResponse:
      type: object
      required:
        - accountId
        - accountStatus
        - message
      properties:
        accountId:
          type: string
        accountStatus:
          type: string
          enum:
            - active
        message:
          type: string
    ValidationErrorItem:
      type: object
      required:
        - field
        - code
        - message
      properties:
        field:
          type: string
        code:
          type: string
        message:
          type: string
    ValidationErrorResponse:
      type: object
      required:
        - code
        - message
        - errors
      properties:
        code:
          type: string
          enum:
            - VALIDATION_FAILED
        message:
          type: string
        errors:
          type: array
          items:
            $ref: "#/components/schemas/ValidationErrorItem"
    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        guidance:
          type: array
          items:
            type: string
        retryAfterSeconds:
          type: integer
          minimum: 1
